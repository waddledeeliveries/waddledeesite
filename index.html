<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- buzz word buzz word SEO SEO bla bla bla -->
    <meta name="description" content="The ultimate community hub for Kirby Air Ride! Share custom machines, check the latest news, click some waddle dees in Waddle Clicker, get featured, and more!">
    <meta name="keywords" content="Kirby Air Riders, Discord Kirby Air Riders, Kirby Air Riders Community, Waddle Dee Kirby, Kirby Community Server Discord">
    <meta name="author" content="waddledee.site">
    <meta name="theme-color" content="#FF8F45">

    <meta property="og:type" content="website">
    <meta property="og:url" content="https://waddledee.site/">
    <meta property="og:title" content="waddlOS - THE Kirby Air Riders Hub">
    <meta property="og:description" content="Join the community! Share machines, read the news, click some waddle dees, and explore the waddlOS.">
    <meta property="og:image" content="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true">

    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://waddledee.site/">
    <meta property="twitter:title" content="waddlOS - THE Kirby Air Riders Hub">
    <meta property="twitter:description" content="Join the community! Share machines, read the news, click some waddle dees, and explore the waddlOS.">
    <meta property="twitter:image" content="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true">

    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com https://apis.google.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://*.googleapis.com https://*.firebaseio.com https://identitytoolkit.googleapis.com https://securetoken.googleapis.com https://waddlewarehouse.onrender.com; media-src 'self' https:; frame-src 'self' https://*.firebaseapp.com https://*.google.com;">
    <title>waddlOS - THE Kirby Air Riders Hub</title>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInWithCustomToken, updateProfile } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, getDocs, writeBatch, runTransaction, updateDoc, getDoc, setDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app-check.js";

        // --- config ---
        
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "PASTE_YOUR_FIREBASE_API_KEY_HERE",
            authDomain: "YOUR_PROJECT.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT.firebasestorage.app", 
            messagingSenderId: "000000000",
            appId: "1:00000000:web:00000000"
        };

        // finally decided to choose this backend, takes a while to wind up thooo
        const BACKEND_URL = "https://waddlewarehouse.onrender.com"; 

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        
        function escapeHTML(str) {
            if (!str) return '';
            return str.toString().replace(/[&<>'"]/g, 
                tag => ({
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    "'": '&#39;',
                    '"': '&quot;'
                }[tag]));
        }

        function isValidUsername(text) {
            const regex = /^[a-zA-Z0-9_]+$/;
            return regex.test(text);
        }

        // this porbobabllylyy can be bypassed easly but i dont care if i catch yall im banning yoooo permanently bru
        // im sorry for the swear words
        const BLOCKED_WORDS = ["fuck", "nigg", "dick", "penis", "rape", "rapist", "shit", "bitch", "ass", "cum", "boob", "porn", "https", "www."]; 

        function hasProfanity(text) {
            if (!text) return false;
            const lower = text.toLowerCase();
            return BLOCKED_WORDS.some(word => lower.includes(word));
        }

        async function seedDatabaseIfEmpty() {
            try {
                const newsRef = collection(db, 'artifacts', appId, 'public', 'data', 'news');
                const snapshot = await getDocs(newsRef);
                if (snapshot.empty) {
                    const batch = writeBatch(db);
                    const seedData = [
                        {
                            title: "hello",
                            content: "the.. news didn't load in. kinda awkward innit???????",
                            img: "",
                            tag: "Placeholder",
                            timestamp: Date.now()
                        }
                    ];
                    seedData.forEach(item => batch.set(doc(newsRef), item));
                    await batch.commit();
                }
                const gameStateRef = doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'global');
                const gameSnap = await getDoc(gameStateRef);
                if (!gameSnap.exists()) {
                    await setDoc(gameStateRef, { globalProbability: 0.001, lastWinner: "None", jackpotPool: 0 });
                }
            } catch (e) { console.error("Error seeding:", e); }
        }
        
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                window.dispatchEvent(new Event('firebase-ready'));
                seedDatabaseIfEmpty();
            } catch (e) {
                console.error("Auth failed:", e);
                window.dispatchEvent(new Event('firebase-ready'));
            }
        };
        initAuth();

        window.login = () => signInWithPopup(auth, new GoogleAuthProvider()).then(() => showToast('ðŸ‘ Welcome!')).catch(e => showToast('Login Failed: ' + e.message));
        window.logout = () => signOut(auth).then(() => showToast('ðŸ‘‹ Signed out.'));
        
        // --- bunch oooo logicc ---
        let canClick = true;
        let globalProb = 0.001;
        
        window.bootOS = function() {
             initAuthSystem(); 
             loadNews(); 
             initMachineListener();
             
             onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'game_state', 'global'), (docSn) => {
                if(docSn.exists()) {
                    globalProb = docSn.data().globalProbability || 0.001;
                    const pct = Math.min(globalProb, 100).toFixed(3);
                    const bar = document.getElementById('probBar');
                    const text = document.getElementById('probText');
                    if(bar) bar.style.width = pct + '%';
                    if(text) text.textContent = pct + '%';
                }
             });

             // really cool animation thx
             const appContainer = document.querySelector('.waddle-app-container');
             if(appContainer) {
                appContainer.addEventListener('scroll', () => {
                    const dee = document.getElementById('peekDee');
                    
                    if (!window.peekDeeActive) { 
                        dee.style.right = "-200px"; 
                        return; 
                    }

                    if (appContainer.scrollTop > 400) dee.style.right = "0px";
                    else dee.style.right = "-200px";
                });
             }
             const cvs = document.getElementById('soulCanvas'); 
             if(cvs) {
                 const ctx = cvs.getContext('2d');
                 cvs.width=1000; cvs.height=800;
                 let pts = Array(50).fill().map(()=>({x:Math.random()*1000, y:Math.random()*800, v:Math.random()*0.5+0.1}));
                 function anim() {
                    ctx.clearRect(0,0,1000,800); ctx.fillStyle='rgba(255,255,255,0.2)';
                    pts.forEach(p=>{ p.x+=p.v; p.y+=p.v; if(p.x>1000)p.x=0; if(p.y>800)p.y=0; ctx.beginPath(); ctx.arc(p.x,p.y,2,0,7); ctx.fill(); });
                    requestAnimationFrame(anim);
                 }
                 anim();
             }
        }
        // i love having my entire website client sided ahhhhhhhh
        function initAuthSystem() {
            onAuthStateChanged(auth, async (user) => {
                if (user && user.displayName) {
                    let cleanName = user.displayName.replace(/[^a-zA-Z0-9_]/g, '');
                    if(cleanName.length > 16) cleanName = cleanName.substring(0, 16);
                    if(cleanName.length < 3) cleanName = "WaddleDee" + Math.floor(Math.random() * 1000);

                    const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', cleanName);
                    
                    try {
                        const snap = await getDoc(usernameRef);
                        if (snap.exists() && snap.data().uid !== user.uid) {
                            cleanName = "WaddleDee" + Math.floor(100000 + Math.random() * 900000);
                        }

                        await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'usernames', cleanName), { 
                            uid: user.uid,
                            claimedAt: serverTimestamp()
                        }, { merge: true });

                        if (user.displayName !== cleanName) {
                            await updateProfile(user, { displayName: cleanName });
                            user.displayName = cleanName; 
                        }
                    } catch(e) { console.error("Username logic error", e); }
                }

                window.currentUser = user;
                updateAuthUI();
                if(user && !user.isAnonymous) {
                    document.getElementById('gameLoginOverlay').style.display = 'none';
                    document.getElementById('accLoginOverlay').style.display = 'none';
                    initGameListeners(user.uid); 
                } else {
                    document.getElementById('gameLoginOverlay').style.display = 'flex';
                    document.getElementById('accLoginOverlay').style.display = 'flex';
                }
            });
        }

        function initGameListeners(uid) {
            onSnapshot(doc(db, 'artifacts', appId, 'users', uid, 'game_stats', 'main'), (docSn) => {
                if(docSn.exists()) {
                    const data = docSn.data();
                    const pts = document.getElementById('userPoints');
                    const tix = document.getElementById('userTickets');
                    if(pts) pts.textContent = data.points || 0;
                    if(tix) tix.textContent = data.tickets || 0;
                }
            });
            loadUserMachinesForShop(uid);
        }

        window.clickDee = async function() {
            const currentUser = window.currentUser;
            if(!currentUser || currentUser.isAnonymous) { window.login(); return; }
            if(!canClick) return;
            
            window.playDeeSound();
            const dee = document.getElementById('mainDee');
            dee.classList.add('cooldown');
            canClick = false;
            
            const stage = document.getElementById('clickStage');
            const lootDisplay = document.getElementById('lootDisplay');
            const popup = document.createElement('div');
            popup.className = 'loot-popup';
            popup.style.top = '40%';
            stage.appendChild(popup);

            // --- Server Loading UI ---
            popup.textContent = "â³ Connecting...";
            popup.style.fontSize = "1rem";
            popup.style.color = "#666";
            
            // "Wind up" timer: if server takes > 2s, show friendly message
            const windUpTimer = setTimeout(() => {
                popup.textContent = "ðŸ˜´ Waking Server... (approx 15s)";
            }, 2000);

            try {
                const token = await currentUser.getIdToken();
                
                // Using Render Server to prevent cheating
                const response = await fetch(`${BACKEND_URL}/api/click`, { 
                    method: 'POST',
                    headers: { 
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                });
                
                clearTimeout(windUpTimer); // Server responded, clear "waking" message

                if (!response.ok) throw new Error("Server Error");
                
                const data = await response.json();
                
                // Reset popup styles for result
                popup.style.fontSize = ""; 
                popup.style.color = "";

                if (data.wonJackpot) {
                    window.playSound('sfx-jackpot', 1.0);
                    popup.textContent = "ðŸŽ° JACKPOT!!!";
                    lootDisplay.innerHTML = `<h2 style="color:#FFD54F; text-shadow:0 2px 0 #E65100;">THE WADDLE TICKETÂ® â„¢. HAS BEEN. WON!!!</h2>`;
                    setTimeout(() => window.playSound('sfx-open', 1.0), 200);
                } else {
                    popup.textContent = `+${data.score}`;
                    if(data.machine) {
                        lootDisplay.innerHTML = `<div style="animation: popIn 0.3s;"><img src="${data.machine.img}" class="loot-img"><br><span style="color:#444;">${data.machine.name}</span></div>`;
                        setTimeout(() => window.playSound('sfx-open', 0.8), 200);
                    }
                }
            } catch (e) { 
                clearTimeout(windUpTimer);
                console.error("Click failed:", e);
                popup.textContent = "Server Error";
                popup.style.color = "red";
            }
            
            setTimeout(() => popup.remove(), 1500);
            setTimeout(() => { dee.classList.remove('cooldown'); canClick = true; }, 1500);
        }

        window.buyTicket = async function() {
            const currentUser = window.currentUser;
            if(!confirm("Spend 5000 DEES for a ticket?")) return;
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'game_stats', 'main');
            try {
                await runTransaction(db, async (t) => {
                    const docSn = await t.get(userRef);
                    const data = docSn.data();
                    if(data.points < 5000) throw "Not enough DEES!";
                    t.update(userRef, { points: data.points - 5000, tickets: (data.tickets||0) + 1 });
                });
                showToast("Ticket Purchased!");
            } catch(e) { showToast(e.toString()); }
        }

        window.redeemFeature = async function() {
            const currentUser = window.currentUser;
            const select = document.getElementById('userMachinesSelect');
            const machineId = select.value;
            if(!machineId) return;
            const userRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'game_stats', 'main');
            const machineRef = doc(db, 'artifacts', appId, 'public', 'data', 'machines', machineId);
            try {
                await runTransaction(db, async (t) => {
                    const uDoc = await t.get(userRef);
                    if((uDoc.data().tickets || 0) < 1) throw "No tickets!";
                    t.update(userRef, { tickets: uDoc.data().tickets - 1 });
                    t.update(machineRef, { featuredUntil: Date.now() + (12 * 60 * 60 * 1000) });
                });
                showToast("machine featured for 12h!!!");
            } catch(e) { showToast(e.toString()); }
        }

        window.uploadMachine = async function(e) {
            e.preventDefault();
            const currentUser = window.currentUser;
            
            // Basic Checks
            if(!currentUser || currentUser.isAnonymous) { showToast("please sign in with Google first!!"); return; }
            
            const btn = document.getElementById('pubBtn');
            const originalText = btn.innerHTML;
            const fileInput = document.getElementById('mScreenshot');
            const file = fileInput.files[0];
            
            if (!file) { showToast("Please select an image file!"); return; }

            btn.innerHTML = '<i class="fa-solid fa-hourglass-start fa-spin"></i> Checking Cooldown...';
            btn.disabled = true;

            try {
                const cooldownRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'private_data', 'cooldowns');
                const cooldownSnap = await getDoc(cooldownRef);
                const now = Date.now();
                
                if(cooldownSnap.exists()) {
                    const last = cooldownSnap.data().community_upload || 0;
                    const diff = now - last;
                    if(diff < 30 * 60 * 1000) { 
                        const waitTime = Math.ceil((30 * 60 * 1000 - diff) / 60000);
                        throw `Rate Limited! Wait ${waitTime} minutes.`;
                    }
                }

                btn.innerHTML = '<i class="fa-solid fa-server fa-bounce"></i> Waking Server... (This may take 1 min)';
                
                const token = await currentUser.getIdToken();

                const formData = new FormData();
                formData.append("image", file);
                
                const response = await fetch(`${BACKEND_URL}/upload`, {
                    method: "POST",
                    headers: {
                        'Authorization': 'Bearer ' + token
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error || "Proxy Server Error");
                }

                const data = await response.json();
                
                if(!data.success) {
                    throw new Error("Upload Failed");
                }
                
                const imageUrl = data.url;
                
                btn.innerHTML = '<i class="fa-solid fa-floppy-disk fa-beat"></i> Saving Data...'; // REALLY cool effects right here

                await runTransaction(db, async (transaction) => {
                    const tCooldownDoc = await transaction.get(cooldownRef);
                    const tNow = Date.now();
                    if(tCooldownDoc.exists()) {
                        const tLast = tCooldownDoc.data().community_upload || 0;
                        if((tNow - tLast) < 30 * 60 * 1000) { 
                            throw "Rate Limited (Race Condition Detected)";
                        }
                    }
                    
                    transaction.set(cooldownRef, { community_upload: tNow }, { merge: true });
                    
                    const machine = {
                        name: document.getElementById('mName').value,
                        code: document.getElementById('mCode').value,
                        category: document.getElementById('mStatType').value,
                        machineType: document.getElementById('mMachineType').value,
                        description: document.getElementById('mDesc').value,
                        image: imageUrl,
                        author: currentUser.displayName,
                        uid: currentUser.uid,
                        timestamp: Date.now()
                    };
                    const newDocRef = doc(collection(db, 'artifacts', appId, 'public', 'data', 'machines'));
                    transaction.set(newDocRef, machine);
                });

                window.playSound('sfx-click');
                showToast('Machine published! ðŸ‘');
                e.target.reset();
                window.toggleUpload();
            } catch (err) { 
                console.error(err); 
                showToast('Error: ' + err.toString().replace("Error: ", "")); 
            } finally { 
                btn.innerHTML = "Publish!"; 
                btn.disabled = false; 
            }
        }

        window.deleteMachine = async function(docId) {
            if(confirm("Delete machine?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'machines', docId));
                    showToast('deleted!!!!');
                } catch(err) { showToast('Error deleting: ' + err.message); }
            }
        }
        
        window.saveProfile = async function() {
            const currentUser = window.currentUser;
            if(!currentUser) return;
            const newName = document.getElementById('accDisplayName').value;
            
            if(newName.length > 16 || newName.length < 3) { showToast("Name must be 3-16 chars!"); return; }

            if (!isValidUsername(newName)) {
                showToast("Only letters, numbers, and _ allowed!");
                const btn = document.getElementById('saveProfileBtn');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fa-solid fa-ban"></i> Bad Char';
                btn.style.background = '#FF5252';
                
                const input = document.getElementById('accDisplayName');
                input.style.border = "2px solid #FF5252";
                input.animate([
                    { transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, 
                    { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }
                ], { duration: 400 });

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    input.style.border = "";
                }, 2000);
                return;
            }

            if(hasProfanity(newName)) {
                showToast("Name contains restricted words!");
                const btn = document.getElementById('saveProfileBtn');
                const originalText = btn.innerHTML;
                
                btn.innerHTML = '<i class="fa-solid fa-ban"></i> Restricted';
                btn.style.background = '#FF5252';
                
                const input = document.getElementById('accDisplayName');
                input.style.border = "2px solid #FF5252";
                input.animate([
                    { transform: 'translateX(0)' },
                    { transform: 'translateX(-10px)' },
                    { transform: 'translateX(10px)' },
                    { transform: 'translateX(0)' }
                ], { duration: 400 });

                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    input.style.border = "";
                }, 2000);
                return;
            }
            
            const btn = document.getElementById('saveProfileBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Checking Availability...';
            btn.disabled = true;
            
            try {
                const usernameRef = doc(db, 'artifacts', appId, 'public', 'data', 'usernames', newName);
                const usernameSnap = await getDoc(usernameRef);
                
                if (usernameSnap.exists() && usernameSnap.data().uid !== currentUser.uid) {
                    throw "Username is already taken!";
                }

                // Continue with transaction...
                const userStatRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'game_stats', 'main');
                const userProfileRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'private_data', 'profile');
                
                await runTransaction(db, async (transaction) => {
                    const profileDoc = await transaction.get(userProfileRef);
                    const statsDoc = await transaction.get(userStatRef);
                    let hasChangedName = profileDoc.exists() ? profileDoc.data().hasChangedName : false;
                    
                    if (hasChangedName) {
                        if (!statsDoc.exists() || (statsDoc.data().tickets || 0) < 1) throw "No WADDLE Tickets!";
                        transaction.update(userStatRef, { tickets: (statsDoc.data().tickets || 0) - 1 });
                    }
                    transaction.set(userProfileRef, { hasChangedName: true }, { merge: true });
                    
                    transaction.set(usernameRef, { uid: currentUser.uid, claimedAt: serverTimestamp() });
                });
                
                await updateProfile(currentUser, { displayName: newName, photoURL: window.selectedIcon });
                
                // --- Instant Visual Refresh Logic ---
                window.updateAuthUI(); // Update top-right corner immediately
                
                // Update all cards belonging to this user
                const cards = document.querySelectorAll(`.machine-by-${currentUser.uid}`);
                cards.forEach(card => {
                     const authorSpan = card.querySelector('.machine-author');
                     if(authorSpan) authorSpan.textContent = newName;
                });

                // Update local data too so filtering doesn't revert it instantly
                if(window.communityMachinesData) {
                    Object.values(window.communityMachinesData).forEach(m => {
                        if(m.uid === currentUser.uid) m.author = newName;
                    });
                }
                
                btn.innerHTML = '<i class="fa-solid fa-check"></i> Saved!';
                btn.style.background = '#4CAF50';
                showToast("Profile Updated!"); 
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);
                
            } catch(e) { 
                showToast(e.toString()); 
                btn.innerHTML = '<i class="fa-solid fa-xmark"></i> Error';
                btn.style.background = '#FF5252';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);
            }
        }

        function loadNews() {
            const newsRef = collection(db, 'artifacts', appId, 'public', 'data', 'news');
            const q = query(newsRef, orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const feed = document.getElementById('newsFeed');
                if(!feed) return;
                feed.innerHTML = '';
                if(snapshot.empty) { feed.innerHTML = '<p style="text-align:center; color:white;">No news found. Check back later!</p>'; return; }
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const card = document.createElement('div');
                    card.className = 'news-featured'; 
                    card.innerHTML = `<div class="tag" style="position:absolute; top:20px; left:20px; z-index:2;">${escapeHTML(data.tag || 'Update')}</div>
                    <img src="${escapeHTML(data.img)}" class="featured-img" onerror="this.src='https://placehold.co/800x400?text=News'">
                    <div class="featured-overlay">
                        <h1 style="font-family:'Fredoka'; font-size:2rem; margin:0; text-shadow:0 2px 5px rgba(0,0,0,0.5);">${escapeHTML(data.title)}</h1>
                        <button class="auth-btn" style="background:white; color:var(--orange-dark); margin-top:15px;">Read Article</button>
                    </div>`;
                    card.onclick = () => window.openFirebaseArticle(data);
                    feed.appendChild(card);
                });
            });
        }
        
        function loadUserMachinesForShop(uid) {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'machines'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snap) => {
                const select = document.getElementById('userMachinesSelect');
                select.innerHTML = '';
                snap.forEach(d => {
                    const m = d.data();
                    if(m.uid === uid) {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.textContent = m.name;
                        select.appendChild(opt);
                    }
                });
                if(select.children.length === 0) select.innerHTML = "<option>No machines uploaded</option>";
            });
        }
        
        function initMachineListener() {
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'machines'), orderBy('timestamp', 'desc'));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('communityGrid');
                grid.innerHTML = '';
                if(snapshot.empty) { grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:white;">No community machines yet. Be the first!</p>`; return; }
                let machines = [];
                window.communityMachinesData = {}; 
                snapshot.forEach(d => {
                    const m = d.data();
                    machines.push({id: d.id, ...m});
                    window.communityMachinesData[d.id] = {id: d.id, ...m};
                });
                machines.sort((a, b) => {
                    const now = Date.now();
                    const aFeat = (a.featuredUntil || 0) > now;
                    const bFeat = (b.featuredUntil || 0) > now;
                    if (aFeat && !bFeat) return -1;
                    if (!aFeat && bFeat) return 1;
                    return b.timestamp - a.timestamp;
                });
                machines.forEach(m => {
                    const isOwner = window.currentUser && m.uid === window.currentUser.uid;
                    const isFeat = (m.featuredUntil || 0) > Date.now();
                    const card = document.createElement('div');
                    // Added machine-by-{uid} class for instant refreshing
                    card.className = `machine-card ${isFeat ? 'featured' : ''} machine-by-${m.uid}`;
                    card.dataset.name = m.name.toLowerCase();
                    card.dataset.cat = m.category;
                    card.dataset.uid = m.uid; 
                    card.onclick = (e) => window.openMachineModal(m.id);
                    
                    card.innerHTML = `${isFeat ? '<div class="featured-badge">âœ¨ FEATURED âœ¨</div>' : ''}
                    ${isOwner ? `<button class="delete-btn" onclick="event.stopPropagation(); window.deleteMachine('${m.id}')"><i class="fa-solid fa-trash"></i></button>` : ''}
                    <img src="${escapeHTML(m.image || 'https://placehold.co/300x150/EEE/999?text=No+Image')}" class="machine-img">
                    <h3>${escapeHTML(m.name)}</h3>
                    <div class="code-pill" onclick="event.stopPropagation(); window.copyCode('${escapeHTML(m.code)}')">${escapeHTML(m.code)}</div>
                    <div style="margin-top:10px; font-size:0.8rem; color:#888;">By <span class="machine-author">${escapeHTML(m.author || 'Anon')}</span> â€¢ ${escapeHTML(m.category.toUpperCase())}<br><span style="color:#0067c0;">${escapeHTML(m.machineType || 'Unknown Machine')}</span></div>`;
                    grid.appendChild(card);
                });
                window.filterMachines('community');
            });
        }

        window.openFirebaseArticle = function(data) {
            document.getElementById('articleTitle').textContent = data.title;
            document.getElementById('articleTag').textContent = data.tag;
            let contentHTML = "";
            if(data.images && Array.isArray(data.images) && data.images.length > 0) {
                 document.getElementById('articleHero').src = data.images[0];
                 if(data.images.length > 1) {
                     contentHTML += `<div class="news-gallery">`;
                     data.images.forEach(img => contentHTML += `<img src="${escapeHTML(img)}" onclick="document.getElementById('articleHero').src='${escapeHTML(img)}'">`);
                     contentHTML += `</div>`;
                 }
            } else { document.getElementById('articleHero').src = data.img; }
            
            contentHTML += data.content || "<p>No content available.</p>";
            document.getElementById('articleContent').innerHTML = contentHTML;
            window.nav('article-view');
        }

        window.openMachineModal = function(id) {
            const m = window.communityMachinesData[id];
            if(!m) return;
            document.getElementById('modalTitle').textContent = m.name;
            document.getElementById('modalAuthor').textContent = "By " + (m.author || "Anon");
            document.getElementById('modalType').textContent = m.machineType || "Unknown";
            document.getElementById('modalImg').src = m.image || "https://placehold.co/600x400?text=No+Image";
            document.getElementById('modalCode').textContent = m.code;
            document.getElementById('modalDesc').textContent = m.description || "No description provided.";
            document.getElementById('machineModalOverlay').style.display = 'flex';
            setTimeout(() => document.getElementById('machineModalOverlay').classList.add('active'), 10);
        }

        window.updateAuthUI = function() {
            const authBox = document.getElementById('authBox');
            const uploadWrapper = document.getElementById('uploadWrapper');
            if(window.currentUser && !window.currentUser.isAnonymous) {
                authBox.innerHTML = `<div class="user-badge"><img src="${escapeHTML(window.currentUser.photoURL || 'https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true')}" class="user-avatar"><span style="font-weight:bold;">${escapeHTML(window.currentUser.displayName || 'User')}</span><i class="fa-solid fa-right-from-bracket" onclick="window.logout()" style="color:var(--dedede-red); cursor:pointer; margin-left:5px;"></i></div>`;
                if(uploadWrapper) uploadWrapper.style.display = 'block';
            } else {
                authBox.innerHTML = `<button class="auth-btn google-btn" onclick="window.login()"><img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" style="width:20px; height:20px; margin-right:8px;">Sign in with Google</button>`;
                if(uploadWrapper) uploadWrapper.style.display = 'none';
            }
        }
        
        window.playSound = function(id, vol=1.0) { const s = document.getElementById(id); if(s){ s.currentTime=0; s.volume=vol; s.play().catch(()=>{}); } }
        window.playDeeSound = function() { window.playSound('wanya'); }
        window.nav = function(viewId) {
            window.playSound('sfx-click');
            document.querySelectorAll('.view-container').forEach(el => { el.classList.remove('active'); el.style.display = 'none'; });
            const target = document.getElementById(viewId);
            if(target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
            }
        }
        window.toggleShop = function() {
            window.playSound('sfx-click');
            document.getElementById('shopPanel').classList.toggle('open');
        }
        window.toggleUpload = function() {
            const section = document.getElementById('uploadSection');
            const arrow = document.getElementById('uploadArrow');
            if (section.style.display === 'block') { section.style.display = 'none'; arrow.classList.remove('open'); }
            else { section.style.display = 'block'; arrow.classList.add('open'); }
        }
        window.showToast = function(message) { 
            const toast = document.createElement('div'); toast.className = 'toast'; toast.textContent = message; 
            document.body.appendChild(toast); setTimeout(() => toast.remove(), 3000); 
        }
        window.copyCode = function(code) { navigator.clipboard.writeText(code).then(() => { window.playSound('sfx-click'); window.showToast(`Copied: ${code}`); }); }
        window.filterMachines = function(view) {
            const container = view === 'store' ? document.getElementById('store') : document.getElementById('community');
            const searchTerm = container.querySelector('.search-box').value.toLowerCase();
            const gridId = view === 'store' ? 'storeGrid' : 'communityGrid';
            const cards = document.querySelectorAll(`#${gridId} .machine-card`);
            const category = window.currentFilter ? window.currentFilter[view] : 'all';
            cards.forEach(card => {
                const name = card.dataset.name || '';
                const cat = card.dataset.cat;
                const matchesCat = category === 'all' || cat === category;
                if(name.includes(searchTerm) && matchesCat) card.style.display = 'flex'; else card.style.display = 'none';
            });
        }
        window.filterCategory = function(category, btn, view) {
            if(!window.currentFilter) window.currentFilter = { store: 'all', community: 'all' };
            window.currentFilter[view] = category;
            const container = view === 'store' ? document.getElementById('store') : document.getElementById('community');
            container.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            window.filterMachines(view);
        }
        window.closeMachineModal = function() {
            const overlay = document.getElementById('machineModalOverlay');
            overlay.classList.remove('active');
            setTimeout(() => overlay.style.display = 'none', 300);
        }
        window.toggleMusic = function() {
            const bgm = document.getElementById('bgm');
            if(window.musicPlaying) { bgm.pause(); window.musicPlaying = false; }
            else { bgm.volume = 0.3; bgm.play().then(() => { window.musicPlaying = true; }).catch(e => console.log("audio blocked")); }
        }
        window.animateLogo = function(el) {
            if(window.logoCooldown) return;
            window.logoCooldown = true;
            window.playSound('wanya', 1.0);
            if(el) { el.classList.add('logo-pop'); setTimeout(() => { el.classList.remove('logo-pop'); window.logoCooldown = false; }, 1000); } 
        }
        window.hidePeekDee = function() {
            window.playDeeSound();
            const dee = document.getElementById('peekDee');
            dee.style.right = '-200px';
            window.peekDeeActive = false;
        }
        
        let zIndex = 100;
        window.focusWindow = function(id) { zIndex++; document.getElementById(id).style.zIndex = zIndex; }
        window.minimizeWindow = function(id) { document.getElementById(id).classList.add('minimized'); document.getElementById('task-' + id.replace('win-', '')).classList.remove('open'); }
        window.closeWindow = function(id) { window.minimizeWindow(id); window.playSound('sfx-open', 0.3); }
        window.restoreWindow = function(id) {
            const win = document.getElementById(id);
            win.classList.remove('minimized');
            window.focusWindow(id);
            document.getElementById('task-' + id.replace('win-', '')).classList.add('open');
        }
        window.toggleMaximize = function(id) { document.getElementById(id).classList.toggle('maximized'); window.focusWindow(id); }
        window.toggleWindow = function(id) {
            const win = document.getElementById(id);
            if (win.classList.contains('minimized')) window.restoreWindow(id);
            else if (parseInt(win.style.zIndex) === zIndex) window.minimizeWindow(id);
            else window.focusWindow(id);
        }
        window.openApp = function(appType) {
            window.playSound('sfx-click');
            if(Math.random() > 0.85) window.peekDeeActive = true;
            if (appType === 'about') window.restoreWindow('win-about');
            else if (appType === 'clicker') window.restoreWindow('win-clicker');
            else if (appType === 'account') { window.restoreWindow('win-account'); window.loadAccountSettings(); }
            else {
                window.restoreWindow('win-browser');
                if (appType === 'home') window.nav('home');
                else if (appType === 'garage') window.nav('store');
                else if (appType === 'community') window.nav('community');
                else if (appType === 'news') window.nav('news');
            }
        }
        
        window.loadAccountSettings = function() {
            const grid = document.getElementById('avatarGrid');
            grid.innerHTML = "";
            const currentPhoto = window.currentUser && window.currentUser.photoURL ? window.currentUser.photoURL : "https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true";
            window.selectedIcon = currentPhoto;
            if(window.currentUser) { 
                document.getElementById('accDisplayName').value = window.currentUser.displayName || ""; 
                
                // Logic check for button price
                const userProfileRef = doc(db, 'artifacts', appId, 'users', window.currentUser.uid, 'private_data', 'profile');
                getDoc(userProfileRef).then(snap => {
                    const btn = document.getElementById('saveProfileBtn');
                    if(snap.exists() && snap.data().hasChangedName) {
                        btn.innerText = "Save (Cost: 1 ðŸŽŸï¸)";
                    } else {
                        btn.innerText = "Save (First Free!)";
                    }
                }).catch(() => document.getElementById('saveProfileBtn').innerText = "Save");
            }

            // accounttt htinnggggg
            const presetIcons = [
            "https://cdn.wikirby.com/thumb/a/ae/KARs_Waddle_Dee_icon.png/120px-KARs_Waddle_Dee_icon.png", 
            "https://cdn.wikirby.com/thumb/f/f5/KARs_Marx_icon.png/120px-KARs_Marx_icon.png", 
            "https://cdn.wikirby.com/thumb/9/9d/KARs_Kirby_icon.png/120px-KARs_Kirby_icon.png",
            "https://cdn.wikirby.com/thumb/d/de/KARs_Magolor_icon.png/120px-KARs_Magolor_icon.png",
            "https://cdn.wikirby.com/thumb/5/56/KARs_Rick_icon.png/120px-KARs_Rick_icon.png",
            "https://cdn.wikirby.com/thumb/d/d8/KARs_Meta_Knight_icon.png/120px-KARs_Meta_Knight_icon.png"
            ];
            presetIcons.forEach(url => {
                const d = document.createElement('div');
                d.className = 'avatar-option' + (url === currentPhoto ? ' selected' : '');
                d.innerHTML = `<img src="${url}">`;
                d.onclick = () => {
                    document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
                    d.classList.add('selected');
                    window.selectedIcon = url;
                };
                grid.appendChild(d);
            });
        }
        
        document.body.addEventListener('click', () => {
            if (!window.musicPlaying) {
                const bgm = document.getElementById('bgm');
                if(bgm) {
                    bgm.volume = 0.3;
                    bgm.play().then(() => {
                        window.musicPlaying = true;
                    }).catch(e => console.log("audio autoplay blockedd depends on browser"));
                }
            }
        }, { once: true });

        // --- yessiurrrrrr i loveee workinnnnnggg o nthissss hwhahahahahaa ---
        function makeDraggable(elmnt, handleId) {
            let pos1=0, pos2=0, pos3=0, pos4=0;
            const handle = document.getElementById(handleId);

            const dragMouseDown = (e) => {
                if(elmnt.classList.contains('maximized')) return;
                
                // Get initial position (mouse or touch)
                if(e.type === 'touchstart') {
                    pos3 = e.touches[0].clientX;
                    pos4 = e.touches[0].clientY;
                } else {
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                }

                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
                document.ontouchend = closeDragElement;
                document.ontouchmove = elementDrag;
                
                window.focusWindow(elmnt.id);
            };

            const elementDrag = (e) => {
                let clientX, clientY;
                
                if(e.type === 'touchmove') {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    e.preventDefault();
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                pos1 = pos3 - clientX;
                pos2 = pos4 - clientY;
                pos3 = clientX;
                pos4 = clientY;
                
                elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
            };

            const closeDragElement = () => {
                document.onmouseup = null;
                document.onmousemove = null;
                document.ontouchend = null;
                document.ontouchmove = null;
            };

            handle.onmousedown = dragMouseDown;
            handle.ontouchstart = dragMouseDown;
        }
        makeDraggable(document.getElementById("win-browser"), "drag-browser");
        makeDraggable(document.getElementById("win-about"), "drag-about");
        makeDraggable(document.getElementById("win-clicker"), "drag-clicker");
        makeDraggable(document.getElementById("win-account"), "drag-account");
        
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), 1000);
        
        if (window.db) window.bootOS();
        else { window.addEventListener('firebase-ready', window.bootOS); setTimeout(() => { if(window.db) window.bootOS(); }, 3000); }
    </script>
    
    <!-- fontsssssss -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Nunito:wght@400;600;800;900&family=Segoe+UI:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- cursorssss --- */
        :root {
            --cursor-normal: url('https://github.com/waddledeeliveries/waddledeesite/blob/main/WaddleIdle.cur?raw=true') 8 8, auto;
            --cursor-hover: url('https://github.com/waddledeeliveries/waddledeesite/blob/main/WaddleHover.cur?raw=true') 10 10, pointer;
            --cursor-click: url('https://github.com/waddledeeliveries/waddledeesite/blob/main/WaddleClick.cur?raw=true') 10 10, move;
            --cursor-resize: url('https://github.com/waddledeeliveries/waddledeesite/blob/main/WaddleResize.cur?raw=true') 10 10, se-resize;
            --win-bg: #f3f3f3;
            --taskbar-bg: rgba(243, 243, 243, 0.95);
            --accent: #0067c0;
        }

        body, .window { cursor: var(--cursor-normal); }
        button, a, .desktop-icon, .nav-btn, .news-card, .machine-card, .code-pill, .control-btn, .favorite-btn, .back-btn, .task-icon, .waddle-clicker, i, select, input, .title-bar, .hero-img, .avatar-option { 
            cursor: var(--cursor-hover); 
        }
        button:active, a:active, .desktop-icon:active, .nav-btn:active, .waddle-clicker:active, .hero-img:active { 
            cursor: var(--cursor-click); 
        }

        /* --- bunch o styles --- */
        body {
            margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif;
            background: url('https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOSThumbnail.png?raw=true') no-repeat center center fixed;
            background-size: cover; user-select: none; height: 100vh; width: 100vw;
        }

        .desktop-grid {
            display: flex; flex-direction: column; flex-wrap: wrap;
            height: 90vh; width: fit-content; padding: 10px; gap: 10px;
            position: relative; z-index: 50;
        }

        .desktop-icon {
            width: clamp(84px, 8vw, 120px); height: clamp(90px, 9vw, 130px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border-radius: 4px; transition: 0.2s; text-align: center;
        }
        .desktop-icon:hover { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(5px); }
        .desktop-icon.active { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); }
        
        .icon-img { width: clamp(48px, 5vw, 80px); height: clamp(48px, 5vw, 80px); margin-bottom: 5px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .icon-label { color: white; font-size: clamp(12px, 1.2vw, 16px); text-shadow: 0 1px 2px rgba(0,0,0,0.8); line-height: 1.2; }

        .window {
            position: absolute; background: white; border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4), 0 0 0 1px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; overflow: hidden;
            min-width: 300px; min-height: 200px;
            animation: openWindow 0.2s cubic-bezier(0.1, 0.9, 0.2, 1);
            resize: both; overflow: hidden;
        }
        .window::after {
            content: ''; position: absolute; bottom: 0; right: 0;
            width: 40px; height: 40px; cursor: var(--cursor-resize); z-index: 1000;
        }
        .window.maximized { top: 0 !important; left: 0 !important; width: 100% !important; height: calc(100% - 48px) !important; transform: none !important; border-radius: 0; resize: none; }
        .window.minimized { transform: scale(0.8) translateY(100vh); opacity: 0; pointer-events: none; }
        @keyframes openWindow { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .title-bar { height: 32px; min-height: 32px; background: #f0f0f0; display: flex; justify-content: space-between; align-items: center; padding-left: 10px; user-select: none; }
        .title-drag-area { flex-grow: 1; height: 100%; display: flex; align-items: center; font-size: 12px; color: #666; }
        .window-controls { display: flex; height: 100%; }
        .control-btn { width: 46px; height: 100%; display: flex; justify-content: center; align-items: center; transition: 0.2s; font-size: 10px; }
        .control-btn:hover { background: #e0e0e0; }
        .close-btn:hover { background: #c42b1c; color: white; }
        .window-content { flex-grow: 1; position: relative; overflow: hidden; background: white; display: flex; flex-direction: column; }
        .browser-bar { height: 40px; min-height: 40px; background: #f9f9f9; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .url-input { flex-grow: 1; background: white; border: 1px solid #ddd; border-radius: 20px; padding: 4px 15px; font-size: 12px; color: #555; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }

        /* cool taskbar..! */
        #taskbar { 
            position: fixed; bottom: 0; left: 0; width: 100%; height: 48px; 
            background: var(--taskbar-bg); backdrop-filter: blur(20px); 
            display: flex; justify-content: center; align-items: center; 
            border-top: 1px solid rgba(255,255,255,0.2); 
            z-index: 2147483647; 
        }
        .taskbar-icons { display: flex; gap: 4px; height: 100%; align-items: center; }
        .task-icon { width: 40px; height: 40px; border-radius: 4px; display: flex; justify-content: center; align-items: center; transition: 0.2s; position: relative; }
        .task-icon:hover { background: rgba(255,255,255,0.4); }
        .task-icon:active { transform: scale(0.9); }
        .task-icon.open::after { content: ''; position: absolute; bottom: 0; width: 12px; height: 3px; background: #0067c0; border-radius: 2px; }
        .task-icon img { width: 24px; height: 24px; }
        .taskbar-right { position: absolute; right: 10px; display: flex; align-items: center; gap: 15px; font-size: 12px; }

        /* --- apps!!! the most important!!! --- */
        .waddle-app-container {
            width: 100%; height: 100%; position: relative; z-index: 10; 
            overflow-y: auto; overflow-x: hidden;
            --orange-main: #FF8F45; --orange-dark: #E65100; --bandana-blue: #29B6F6; --dedede-red: #FF5252;
            --text-dark: #4E342E; --glass: rgba(255, 255, 255, 0.95); --radius: 24px; --shadow-pop: 0 10px 25px -5px rgba(0,0,0,0.15);
            background: transparent; 
            font-family: 'Nunito', sans-serif; color: var(--text-dark);
            padding-bottom: 80px; scroll-behavior: smooth;
        }

        /* waddle dee wants yur soul....... ahhahaa oh yea and HELL beginning down below i aint docummenting ALLAT */
        #soulCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: radial-gradient(circle at 50% 50%, #FF9E5E 0%, #E65100 100%); }

        .waddle-app-container header {
            position: sticky; top: 0; width: 100%; height: 90px; background: var(--glass); backdrop-filter: blur(20px);
            border-bottom: 5px solid var(--orange-dark); display: flex; justify-content: space-between; align-items: center;
            padding: 0 3rem; z-index: 1000; box-shadow: 0 5px 30px rgba(0,0,0,0.1); box-sizing: border-box;
        }

        .brand-logo { height: 60px; filter: drop-shadow(0 5px 0 rgba(0,0,0,0.1)); transition: transform 0.3s; }
        .brand-logo.logo-pop { animation: logoPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes logoPop { 0% { transform: scale(1); } 50% { transform: scale(1.1) rotate(5deg); } 100% { transform: scale(1); } }

        .auth-btn { background: #5865F2; color: white; border: none; padding: 12px 28px; border-radius: 50px; font-family: 'Fredoka', sans-serif; font-weight: 800; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 0 #404EED; transition: transform 0.1s, box-shadow 0.1s; font-size: 1rem; }
        .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 0 #404EED; }
        .auth-btn:active { transform: translateY(4px); box-shadow: none; }
        .google-btn { background: white; color: #444; box-shadow: 0 6px 0 #DDD; }
        .google-btn:hover { box-shadow: 0 8px 0 #DDD; }

        .user-badge { display: flex; align-items: center; gap: 12px; background: white; padding: 6px 20px 6px 6px; border-radius: 50px; border: 3px solid var(--orange-main); }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--orange-dark); object-fit: cover;}

        .view-container { max-width: 1400px; margin: 0 auto; padding: 20px; margin-top: 20px; display: none; opacity: 0; animation: fadeScaleUp 0.5s forwards ease-out; position: relative; z-index: 1; }
        .view-container.active { display: block; opacity: 1; }
        @keyframes fadeScaleUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        .hero-banner { text-align: center; margin-bottom: 40px; position: relative; }
        .hero-img { max-width: 600px; width: 90%; filter: drop-shadow(0 20px 10px rgba(0,0,0,0.1)); animation: floatHero 6s ease-in-out infinite; transition: transform 0.2s; }
        @keyframes floatHero { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }
        .hero-img.logo-pop { animation: logoPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .grid-layout { display: grid; grid-template-columns: 2.5fr 1fr; gap: 40px; }
        .news-featured { background: white; border-radius: var(--radius); overflow: hidden; position: relative; border: 6px solid white; box-shadow: var(--shadow-pop); transition: transform 0.3s; margin-bottom: 30px; }
        .news-featured:hover { transform: translateY(-5px); }
        .featured-img { width: 100%; height: 400px; object-fit: cover; }
        .news-gallery { display: flex; gap: 5px; padding: 0 20px 20px; overflow-x: auto; }
        .news-gallery img { height: 100px; width: auto; border-radius: 10px; border: 2px solid #eee; cursor: pointer; transition: transform 0.2s; }
        .news-gallery img:hover { transform: scale(1.05); }

        .featured-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); padding: 40px; color: white; box-sizing: border-box; }
        .tag { background: var(--dedede-red); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.8rem; }

        .widget { background: white; border-radius: var(--radius); padding: 25px; margin-bottom: 30px; border: 2px solid rgba(255,255,255,0.5); box-shadow: var(--shadow-pop); }
        .widget-header { font-family: 'Fredoka'; font-size: 1.4rem; color: var(--orange-dark); border-bottom: 2px dashed #EEE; padding-bottom: 15px; margin-bottom: 20px; }
        .discord-embed { background: #5865F2; color: white; border-radius: 15px; padding: 20px; text-align: center; position: relative; overflow: hidden; }
        .back-btn { display: inline-flex; align-items: center; gap: 10px; background: white; padding: 10px 25px; border-radius: 50px; font-weight: bold; color: var(--orange-main); margin-bottom: 30px; border: none; box-shadow: 0 5px 0 rgba(0,0,0,0.05); }
        .back-btn:hover { transform: translateX(-10px); }

        .article-paper { background: white; border-radius: 30px; overflow: hidden; box-shadow: var(--shadow-pop); }
        .article-hero { width: 100%; height: 400px; object-fit: cover; }
        .article-body { padding: 50px; line-height: 1.8; font-size: 1.1rem; color: #444; }
        .article-meta { display: flex; gap: 20px; color: #888; font-size: 0.9rem; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #EEE; }

        .machine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .machine-card {
            background: #fdfdfd;
            border-radius: 16px;
            padding: 15px; 
            border: 8px solid white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.08); 
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); //BOUNCY WOOWOHOHOOH
            position: relative; 
            display: flex; 
            flex-direction: column; 
            overflow: visible;
            transform-style: preserve-3d;
        }

        .machine-card:hover { 
            transform: translateY(-10px) rotate(1deg) scale(1.02); 
            box-shadow: 0 15px 30px rgba(255, 143, 69, 0.3); 
            z-index: 10; 
            border-color: #fff;
        }

        .machine-card.official { 
            background: linear-gradient(180deg, #E3F2FD 0%, #FFFFFF 100%);
            border: 4px solid #90CAF9; 
        }
        
        .machine-card.featured { 
            background: linear-gradient(135deg, #FFF8E1 0%, #FFFFFF 100%);
            border: 4px solid #FFD54F;
            box-shadow: 0 15px 40px rgba(255, 193, 7, 0.4); 
        }
        .verified-badge, .featured-badge { position: absolute; top: -15px; padding: 5px 15px; border-radius: 10px; font-weight: bold; font-size: 0.8rem; border: 2px solid white; }
        .verified-badge { right: 20px; background: var(--bandana-blue); color: white; box-shadow: 0 5px 10px rgba(41, 182, 246, 0.3); }
        .featured-badge { left: 20px; background: #FFD54F; color: #5D4037; box-shadow: 0 5px 5px rgba(0,0,0,0.1); }
        .machine-img { width: 100%; height: 150px; object-fit: contain; margin-bottom: 15px; background: #f9f9f9; border-radius: 10px; }
        .machine-card h2, .machine-card h3 { margin: 0; font-family:'Fredoka'; font-size: 1.5rem; }
        .machine-card p { font-size: 0.9rem; color: #666; margin-top: 5px; }

        .code-pill { background: #37474F; color: #69F0AE; font-family: monospace; font-size: 1.2rem; padding: 12px; border-radius: 12px; text-align: center; margin-top: 15px; border: 2px dashed #546E7A; transition: 0.2s; }
        .code-pill:active { background: black; transform: scale(0.98); }
        .code-pill:hover { border-color: #69F0AE; }

        .upload-header {
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; user-select: none;
            background: #f8f8f8; padding: 15px 25px; border-radius: 20px;
            margin-bottom: 20px; border: 2px solid #EEE;
            transition: 0.3s;
        }
        .upload-header:hover { background: #f0f0f0; border-color: var(--orange-main); }
        .upload-arrow { transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .upload-arrow.open { transform: rotate(180deg); }

        .upload-container { background: white; padding: 40px; border-radius: 30px; text-align: center; border: 5px solid var(--orange-main); margin-bottom: 50px; box-shadow: inset 0 0 30px rgba(255, 143, 69, 0.1); display: none; }
        
        .form-input { width: 80%; padding: 15px 25px; margin: 10px 0; border-radius: 15px; border: 2px solid #EEE; font-family: 'Nunito'; font-size: 1rem; transition: 0.3s; box-sizing: border-box; }
        .form-input:focus { border-color: var(--orange-main); box-shadow: 0 0 0 4px rgba(255, 143, 69, 0.2); }
        select.form-input { appearance: none; background: white url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23333" d="M6 9L1 4h10z"/></svg>') no-repeat right 20px center; }
        input[type="file"].form-input { padding: 12px; background: white; }
        textarea.form-input { resize: vertical; min-height: 80px; }

        .machine-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); z-index: 5000;
            display: none; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            opacity: 0; transition: opacity 0.3s;
        }
        .machine-modal-overlay.active { opacity: 1; }
        .machine-modal-content {
            background: white; width: 90%; max-width: 800px; max-height: 90vh;
            border-radius: 20px; overflow-y: auto; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            padding: 30px; display: flex; flex-direction: column; gap: 20px;
        }
        .machine-modal-overlay.active .machine-modal-content { transform: scale(1); }
        .modal-img-container { 
            width: 100%; background: #111; border-radius: 15px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; max-height: 500px;
        }
        .modal-img { max-width: 100%; max-height: 500px; object-fit: contain; }
        .modal-close {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.1); border: none;
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .modal-close:hover { background: #FF5252; color: white; }

        #peekDee { position: absolute; bottom: 0; right: -200px; width: 180px; transition: right 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275); z-index: 4000; filter: drop-shadow(-5px 0 10px rgba(0,0,0,0.2)); cursor: pointer; }
        
        .toast { 
            position: fixed; 
            top: 60px; 
            right: 20px; 
            background: white; 
            color: var(--text-dark); 
            padding: 15px 25px; 
            border-radius: 15px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            font-family: 'Fredoka'; 
            font-weight: 600; 
            z-index: 2147483647; 
            animation: slideIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            border-left: 5px solid var(--orange-main); 
        }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .banner-wrapper { position: relative; margin-bottom: 50px; text-align: center; transition: transform 0.3s; }
        .banner-wrapper:hover { transform: scale(1.01); }
        .wide-banner { width: 100%; height: 220px; object-fit: cover; border-radius: 30px; border: 6px solid white; box-shadow: var(--shadow-pop); }
        .banner-badge { background: white; color: var(--text-dark); font-family: 'Fredoka'; font-size: 1.2rem; font-weight: bold; padding: 12px 40px; border-radius: 50px; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 4px solid var(--orange-main); z-index: 10; white-space: nowrap; }

        .controls-bar { background: white; border-radius: 20px; padding: 20px; margin-bottom: 30px; box-shadow: var(--shadow-pop); display: flex; gap: 15px; flex-wrap: wrap; align-items: center; }
        .search-box { flex: 1; min-width: 250px; padding: 12px 20px; border-radius: 50px; border: 2px solid #EEE; font-family: 'Nunito'; font-size: 1rem; transition: 0.3s; }
        .search-box:focus { border-color: var(--orange-main); box-shadow: 0 0 0 4px rgba(255, 143, 69, 0.2); }
        .filter-btn { padding: 10px 20px; border-radius: 50px; border: 2px solid #EEE; background: white; font-family: 'Fredoka'; font-weight: 600; transition: all 0.3s; }
        .filter-btn.active { background: var(--orange-main); color: white; border-color: var(--orange-main); }
        .delete-btn { position: absolute; top: 10px; right: 10px; background: #FF5252; color: white; border: none; border-radius: 5px; width: 30px; height: 30px; cursor: pointer; opacity: 0; transition: opacity 0.2s; z-index: 10; }
        .machine-card:hover .delete-btn { opacity: 1; }

        .game-layout { display: flex; height: 100%; flex-direction: column; align-items: center; background: #FFF3E0; padding: 20px; font-family: 'Fredoka'; position: relative; overflow: hidden; }
        .prob-container { width: 100%; max-width: 500px; text-align: center; margin-bottom: 20px; z-index: 2; }
        .prob-bar-bg { width: 100%; height: 30px; background: #ddd; border-radius: 15px; overflow: hidden; border: 2px solid #bbb; position: relative; }
        .prob-bar-fill { height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 0%; transition: width 0.5s; }
        .prob-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #333; font-weight: bold; font-size: 14px; width: 100%; }
        
        .clicker-stage { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; width: 100%; }
        .waddle-clicker { width: 200px; transition: transform 0.1s; user-select: none; filter: drop-shadow(0 10px 0 rgba(0,0,0,0.1)); }
        .waddle-clicker:active { transform: scale(0.9); filter: drop-shadow(0 2px 0 rgba(0,0,0,0.1)); }
        .waddle-clicker.cooldown { filter: grayscale(1); cursor: not-allowed; opacity: 0.7; }
        
        #lootDisplay { margin-top: 10px; text-align: center; font-size: 1.2rem; color: #E65100; font-weight: bold; min-height: 60px; display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .loot-img { width: 80px; height: 50px; object-fit: contain; animation: popIn 0.3s; }
        @keyframes popIn { 0% { transform: scale(0); } 80% { transform: scale(1.2); } 100% { transform: scale(1); } }

        .game-stats { display: flex; gap: 20px; margin-top: 20px; background: white; padding: 10px 20px; border-radius: 50px; border: 3px solid var(--orange-main); z-index: 2; }
        .shop-panel { position: absolute; right: 20px; top: 20px; width: 250px; background: white; padding: 15px; border-radius: 15px; border: 2px solid #eee; z-index: 3; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; }
        .shop-panel.open { display: block; animation: slideIn 0.3s; }
        .system-logo { width: 100px; margin: 0 auto 20px auto; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }

        /* --- mmmhmhmy god broooooooo helpppp accountt stuff --- */
        .account-layout { padding: 30px; display: flex; flex-direction: column; align-items: center; gap: 20px; font-family: 'Fredoka', sans-serif; background: #FFF3E0; height:100%; }
        .avatar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; }
        .avatar-option { width: 60px; height: 60px; border-radius: 50%; border: 3px solid #eee; transition: 0.2s; padding: 2px; cursor:pointer; background:white; }
        .avatar-option:hover { transform: scale(1.1); }
        .avatar-option.selected { border-color: var(--orange-main); background: #FFF3E0; box-shadow:0 0 0 2px var(--orange-main); }
        .avatar-option img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
    </style>
    <div id="machineModalOverlay" class="machine-modal-overlay" onclick="window.closeMachineModal()">
        <div class="machine-modal-content" onclick="event.stopPropagation()">
            <button class="modal-close" onclick="window.closeMachineModal()">Ã—</button>
            <div class="modal-img-container">
                <img id="modalImg" class="modal-img" src="">
            </div>
            <div style="font-family:'Fredoka'; color:var(--text-dark);">
                <h1 id="modalTitle" style="margin:0; font-size:2.5rem;">Machine Name</h1>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:5px;">
                    <span id="modalAuthor" style="color:#666; font-size:1.1rem;">By Author</span>
                    <span id="modalType" style="background:var(--bandana-blue); color:white; padding:4px 12px; border-radius:15px; font-size:0.9rem;">Type</span>
                </div>
                <div class="code-pill" id="modalCode" onclick="window.copyCode(this.innerText)" style="margin: 20px 0; cursor:pointer;">CODE</div>
                <div id="modalDescSection" style="background:#f9f9f9; padding:15px; border-radius:15px; border-left:4px solid var(--orange-main);">
                    <h3 style="margin:0 0 10px 0; opacity:0.7;">Description</h3>
                    <p id="modalDesc" style="margin:0; line-height:1.6; font-family:'Nunito';">No description provided.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="desktop-grid">
        <div class="desktop-icon" ondblclick="window.openApp('home')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/ugly%20ahh%20home.png?raw=true" class="icon-img">
            <div class="icon-label">Home Page</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('garage')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddle%20garage.png?raw=true" class="icon-img">
            <div class="icon-label">Garage</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('community')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/community%20thing%20ahh.png?raw=true" class="icon-img">
            <div class="icon-label">Community</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('clicker')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddleclicker.png?raw=true" class="icon-img">
            <div class="icon-label">Waddle Clicker</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('news')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/lazynewssss.png?raw=true" class="icon-img">
            <div class="icon-label">News</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('account')">
            <img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" class="icon-img">
            <div class="icon-label">My Account</div>
        </div>
        <div class="desktop-icon" ondblclick="window.openApp('about')">
            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true" class="icon-img">
            <div class="icon-label">About</div>
        </div>
    </div>

    <div id="window-area">
        <div id="win-browser" class="window minimized" style="width: 85%; height: 85%; top: 5%; left: 7.5%; z-index: 100;" onmousedown="window.focusWindow('win-browser')">
            <div class="title-bar" ondblclick="window.toggleMaximize('win-browser')">
                <div class="title-drag-area" id="drag-browser">waddle communicator 3001</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="window.minimizeWindow('win-browser')"><i class="fa-solid fa-minus"></i></div>
                    <div class="control-btn" onclick="window.toggleMaximize('win-browser')"><i class="fa-regular fa-square"></i></div>
                    <div class="control-btn close-btn" onclick="window.closeWindow('win-browser')"><i class="fa-solid fa-xmark"></i></div>
                </div>
            </div>
            <div class="browser-bar">
                <i class="fa-solid fa-arrow-left" style="color:#888; font-size: 14px; cursor:pointer;" onclick="window.nav('home')"></i>
                <i class="fa-solid fa-arrow-right" style="color:#888; font-size: 14px;"></i>
                <i class="fa-solid fa-rotate-right" style="color:#888; font-size: 14px;" onclick="location.reload()"></i>
                <input type="text" class="url-input" value="https://waddledee.site/hub" readonly>
            </div>
            <div class="window-content">
                <canvas id="soulCanvas"></canvas>
                <div class="waddle-app-container">
                    <header>
                        <div class="brand-area">
                            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/ugly%20ahh%20home.png?raw=true" class="brand-logo" alt="Logo" onclick="window.animateLogo(this)">
                        </div>
                        <div id="authBox"></div>
                    </header>
                    
                    <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/wakirby%20dee.png?raw=true" id="peekDee" onclick="window.hidePeekDee()">

                    <div id="home" class="view-container active">
                        <div class="hero-banner">
                            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlething1080512.png?raw=true" alt="Air Ride Hub" class="hero-img" onclick="window.animateLogo(this)">
                        </div>
                        <div class="grid-layout">
                            <div class="widget">
                                <div class="widget-header">about waddledee.site ðŸ¤”</div>
                                <p>Welcome to the ultimate community hub for <strong>Kirby Air Riders</strong>! Connect, share your machines, click some waddle dees, and check the latest news.</p>
                                <p style="font-size:0.9rem; color:#666; margin-top:20px;"><em>Disclaimer: This is a non-profit fan project. Not affiliated with Nintendo/HAL.</em></p>
                            </div>
                             <div class="widget">
                                <div class="widget-header">COMMUNITY HUB</div>
                                <div class="discord-embed">
                                    <i class="fa-brands fa-discord" style="font-size: 40px; margin-bottom: 10px;"></i>
                                    <h3 style="margin:0;">waddledee.site</h3>
                                    <p style="margin:5px 0; font-size:0.9rem; opacity:0.8;">Join the community! Everything Kirby Air Riders!</p>
                                    <a href="https://discord.gg/UJGB9QYc" target="_blank" rel="noopener noreferrer" style="display:inline-block; margin-top:15px; background:white; color:#5865F2; text-decoration:none; padding:8px 20px; border-radius:20px; font-weight:bold;">JOIN SERVER</a>
                                </div>
                            </div>
                            <div class="widget">
                                <div class="widget-header">explore waddlOS!</div>
                                <p>ðŸ’¡ <strong>cool tip:</strong> As the website constantly grows, this "OS" gains more features! Did you know that in <strong>"Waddle Clicker"</strong> you can win a <strong>WADDLE Ticket</strong> to feature a submitted machine for <strong>12h?</strong> (or redeem it for 5000 DEES!)</p>
                            </div>
                            <div class="widget">
                                <div class="widget-header">HEAR FROM OUR COMMUNITY</div>
                                <div style="text-align:center;">
                                    <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddleclicker.png?raw=true" style="width:80px; border-radius:50%; border:3px solid var(--orange-main);">
                                    <h3>waddledeeOBLIERATROR5500</h3>
                                    <p>"i really like the discord server it the best you should join it too"</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="news" class="view-container">
                        <div class="banner-wrapper">
                             <h1 style="font-family:'Fredoka'; color:white; font-size:3rem; text-align:center; margin: 20px 0; text-shadow: 0 4px 0 rgba(0,0,0,0.1);">NEWS & UPDATES</h1>
                        </div>
                        <div id="newsFeed" class="grid-layout" style="grid-template-columns: 1fr;">
                            <p style="text-align:center; color:white;">Loading news from database...</p>
                        </div>
                    </div>

                    <div id="article-view" class="view-container">
                        <button class="back-btn" onclick="window.nav('news')"><i class="fa-solid fa-arrow-left"></i> Back to News</button>
                        <div class="article-paper">
                            <img id="articleHero" src="" class="article-hero">
                            <div class="article-body">
                                <h1 id="articleTitle" style="font-family:'Fredoka'; font-size:3rem; color:var(--text-dark); margin-bottom:10px;"></h1>
                                <div class="article-meta">
                                    <span><i class="fa-solid fa-user"></i> Admin</span>
                                    <span><i class="fa-solid fa-tag"></i> <span id="articleTag"></span></span>
                                </div>
                                <div id="articleContent"></div>
                            </div>
                        </div>
                    </div>

                    <div id="store" class="view-container">
                        <div class="banner-wrapper">
                            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlegarage1360.png?raw=true" class="wide-banner">
                            <div class="banner-badge">âœ… certified by THE waddle dee... âœ…</div>
                        </div>
<div class="widget">
                            <li style="text-align: center;">
    <div class="widget-header">ABOUT</div>
    <p>my garage, ran by THE waddle dee.</p>
    <ol style="margin-left: 0; padding: 0; color:#555; list-style-type: none;">
        <li>1. i flex my own creations</li>
        <li>2. i add YOUR creations that I really liked! (you can call it... the hall of dee)</li>
    </ol>
</li>
                        </div>

                        <div class="controls-bar">
                            <input type="text" class="search-box" placeholder="ðŸ” Search machines..." oninput="window.filterMachines('store')">
                            <button class="filter-btn active" onclick="window.filterCategory('all', this, 'store')">All</button>
                            <button class="filter-btn" onclick="window.filterCategory('speed', this, 'store')">â¤ï¸ waddle favorites</button>
                            <button class="filter-btn" onclick="window.filterCategory('power', this, 'store')">ðŸ’Ž waddle exquisites</button>
                            <button class="filter-btn" onclick="window.filterCategory('flight', this, 'store')">ðŸ’ª waddle's work<button>
                        </div>
                        <div class="machine-grid" id="storeGrid">
                            <div class="machine-card official" data-name="warp star omega" data-cat="balanced">
                                <div class="verified-badge"><i class="fa-solid fa-check"></i></div>
                                <img src="" class="machine-img">
                                <h2 style="color:var(--bandana-blue);">Coming Soon</h2>
                                <p>SOON.</p>
                                <div class="code-pill" onclick="window.copyCode('SOON')">SOON</div>
                            </div>
                        </div>
                    </div>

                    <div id="community" class="view-container">
                        <div class="banner-wrapper">
                            <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlecommunity1360.png?raw=true" class="wide-banner" style="border-color:var(--orange-main);">
                            <div class="banner-badge" style="border-color:var(--orange-main);">â­ real user uploads! â­</div>
                        </div>
                        <div class="controls-bar">
                            <input type="text" class="search-box" placeholder="ðŸ” Search community machines..." oninput="window.filterMachines('community')">
                            <button class="filter-btn active" onclick="window.filterCategory('all', this, 'community')">All</button>
                            <button class="filter-btn" onclick="window.filterCategory('cheap', this, 'community')">ðŸ’° Cheap</button>
                            <button class="filter-btn" onclick="window.filterCategory('expensive', this, 'community')">ðŸ’Ž Expensive</button>
                            <button class="filter-btn" onclick="window.filterCategory('normal', this, 'community')">ðŸš— Normal</button>
                            <button class="filter-btn" onclick="window.filterCategory('game reference', this, 'community')">ðŸŽ® Game Reference</button>
                        </div>
                        
                        <div class="widget">
                            <div class="widget-header">HOW TO UPLOAD</div>
                            <p>how to share YOUR machines 101:</p>
                            <ol style="margin-left:20px; color:#555;">
                                <li>Login with your Google Account</li>
                                <li>Enter your Machine Name and Machine ID (found in details)</li>
                                <li>Select the Machine Model and Tag (just for sorting)</li>
                                <li><strong>Upload your screenshot directly!</strong></li>
                                <li><strong>Note:</strong> You can only upload once every 30 minutes!</li>
                            </ol>
                        </div>

                        <!-- COLLAPSIBLE UPLOAD SECTION -->
                        <div id="uploadWrapper" style="display:none;">
                            <div class="upload-header" onclick="window.toggleUpload()">
                                <h2 style="font-family:'Fredoka'; color:var(--orange-main); margin:0; font-size:1.5rem;">ðŸ› ï¸ Share Your Machine</h2>
                                <i id="uploadArrow" class="fa-solid fa-chevron-down upload-arrow"></i>
                            </div>

                            <div id="uploadSection" class="upload-container">
                                <p>Upload your machine for everyone to see!</p>
                                <form onsubmit="window.uploadMachine(event)">
                                    <input type="text" id="mName" placeholder="Machine Name" class="form-input" required maxlength="20"><br>
                                    <input type="text" id="mCode" placeholder="Code" class="form-input" required maxlength="12"><br>
                                    <select id="mMachineType" class="form-input" required>
                                        <option value="">Select Machine Type...</option>
                                        <option value="Warp Star">Warp Star</option>
                                        <option value="Winged Star">Winged Star</option>
                                        <option value="Shadow Star">Shadow Star</option>
                                        <option value="Wagon Star">Wagon Star</option>
                                        <option value="Slick Star">Slick Star</option>
                                        <option value="Formula Star">Formula Star</option>
                                        <option value="Bulk Star">Bulk Star</option>
                                        <option value="Rocket Star">Rocket Star</option>
                                        <option value="Swerve Star">Swerve Star</option>
                                        <option value="Turbo Star">Turbo Star</option>
                                        <option value="Jet Star">Jet Star</option>
                                        <option value="Wheelie Bike">Wheelie Bike</option>
                                        <option value="Rex Wheelie">Rex Wheelie</option>
                                        <option value="Wheelie Scooter">Wheelie Scooter</option>
                                        <option value="Hop Star">Hop Star</option>
                                        <option value="Vampire Star">Vampire Star</option>
                                        <option value="Paper Star">Paper Star</option>
                                        <option value="Chariot">Chariot</option>
                                        <option value="Battle Chariot">Battle Chariot</option>
                                        <option value="Tank Star">Tank Star</option>
                                        <option value="Bull Tank">Bull Tank</option>
                                        <option value="Transform Star">Transform Star</option>
                                        <option value="Flight Warp Star">Flight Warp Star</option>
                                        <option value="Compact Star">Compact Star</option>
                                    </select><br>
                                    <select id="mStatType" class="form-input" required>
                                        <option value="">Select Tag...</option>
                                        <option value="cheap">ðŸ’° Cheap</option>
                                        <option value="expensive">ðŸ’Ž Expensive</option>
                                        <option value="normal">ðŸš— Normal</option>
                                        <option value="game reference">ðŸŽ® Game Reference</option>
                                    </select><br>
                                    <textarea id="mDesc" class="form-input" placeholder="Optional description... (Max 150 chars)" maxlength="150"></textarea><br>
                                    
                                    <p style="margin:10px 0 5px; font-weight:bold;">Upload Screenshot:</p>
                                    <input type="file" id="mScreenshot" class="form-input" accept="image/*" required><br>
                                    
                                    <button type="submit" id="pubBtn" class="auth-btn" style="margin:20px auto;">Publish!</button>
                                </form>
                            </div>
                        </div>

                        <div id="communityGrid" class="machine-grid">
                            <p style="text-align:center; color:white; width:100%;">Connecting to Database...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-clicker" class="window minimized" style="width: 600px; height: 600px; top: 80px; left: 300px; z-index: 102;" onmousedown="window.focusWindow('win-clicker')">
            <div class="title-bar" ondblclick="window.toggleMaximize('win-clicker')">
                <div class="title-drag-area" id="drag-clicker">click the dee - win da jackpot!</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="window.minimizeWindow('win-clicker')"><i class="fa-solid fa-minus"></i></div>
                    <div class="control-btn close-btn" onclick="window.closeWindow('win-clicker')"><i class="fa-solid fa-xmark"></i></div>
                </div>
            </div>
            <div class="window-content">
                <div class="game-layout">
                    <button style="position:absolute; top:20px; right:20px; background:white; border:none; border-radius:50%; width:40px; height:40px; box-shadow:0 3px 10px rgba(0,0,0,0.1); font-size:1.2rem; z-index: 5; cursor: pointer;" onclick="window.toggleShop()">ðŸ›’</button>
                    <div id="shopPanel" class="shop-panel">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <h3 style="margin:0;">waddle cool shop</h3>
                            <button onclick="window.toggleShop()" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">âŒ</button>
                        </div>
                        <p>Spend 5,000 DEES for a WADDLE ticket!</p>
                        <button class="auth-btn" style="width:100%; justify-content:center; margin-bottom:10px;" onclick="window.buyTicket()">Buy Waddle Ticket (5k)</button>
                        <hr>
                        <h4>Redeem WADDLE Ticket</h4>
                        <p>Feature a machine for 12h!</p>
                        <select id="userMachinesSelect" class="form-input" style="width:100%; margin-bottom:10px;">
                            <option>Loading your machines...</option>
                        </select>
                        <button class="auth-btn" style="width:100%; justify-content:center; background:#E65100;" onclick="window.redeemFeature()">Feature It!</button>
                    </div>
                    <div class="prob-container">
                        <h3>Global Probability Meter</h3>
                        <div class="prob-bar-bg">
                            <div id="probBar" class="prob-bar-fill"></div>
                            <div id="probText" class="prob-text">0.001%</div>
                        </div>
                        <small>Resets when someone wins the Jackpot!</small>
                    </div>
                    <div class="clicker-stage" id="clickStage">
                        <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/clickthedee.png?raw=true" class="waddle-clicker" id="mainDee" onclick="window.clickDee()">
                        <div id="lootDisplay"></div>
                    </div>
                    <div class="game-stats">
                        <span>ðŸ”¶ DEES: <b id="userPoints">0</b></span>
                        <span>ðŸŽŸï¸ WADDLE Tickets: <b id="userTickets">0</b></span>
                    </div>
                    <div id="gameLoginOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; display:none;">
                        <h2>Login Required</h2>
                        <p>save your stats and win BIG PRIZES!</p>
                        <button class="auth-btn google-btn" onclick="window.login()">Login with Google</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="win-about" class="window minimized" style="width: 400px; height: 500px; top: 100px; left: 200px; z-index: 101;" onmousedown="window.focusWindow('win-about')">
            <div class="title-bar" ondblclick="window.toggleMaximize('win-about')">
                <div class="title-drag-area" id="drag-about">About waddlOS</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="window.minimizeWindow('win-about')"><i class="fa-solid fa-minus"></i></div>
                    <div class="control-btn close-btn" onclick="window.closeWindow('win-about')"><i class="fa-solid fa-xmark"></i></div>
                </div>
            </div>
            <div class="window-content" style="padding: 30px; text-align: center; background: #f9f9f9;">
                <img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true" class="system-logo">
                <h2 style="margin: 0 0 20px 0; color: #333;">WaddlOS</h2>
                <div style="text-align: left; background: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e5e5;">
                    <p><strong>WaddlOS</strong></p>
                    <p>Version W1.0</p>
                    <p>Powered by the waddle dees that run outside my house</p>
                    <hr style="border:0; border-top:1px solid #eee; margin: 15px 0;">
                    <p>waddl1.0 - Release!</p>
                </div>
            </div>
        </div>

        <!-- ACCOIUNT SETTINGS... i call it... waddle license -->
        <div id="win-account" class="window minimized" style="width: 350px; height: 650px; top: 50px; left: 350px; z-index: 103;" onmousedown="window.focusWindow('win-account')">
            <div class="title-bar" ondblclick="window.toggleMaximize('win-account')">
                <div class="title-drag-area" id="drag-account">Waddle License</div>
                <div class="window-controls">
                    <div class="control-btn" onclick="window.minimizeWindow('win-account')"><i class="fa-solid fa-minus"></i></div>
                    <div class="control-btn close-btn" onclick="window.closeWindow('win-account')"><i class="fa-solid fa-xmark"></i></div>
                </div>
            </div>
            <div class="window-content" style="background: white;">
                <div class="account-layout">
                    <h2 style="margin:0; color:#333;">Profile Settings</h2>
                    
                    <div style="width:100%; text-align:center;">
                        <label style="display:block; font-size:0.9rem; color:#666; margin-bottom:5px; text-align:left;">Display Name</label>
                        <input type="text" id="accDisplayName" class="form-input" style="width:100%; margin:0 0 10px 0;" placeholder="Enter name..." maxlength="16">
                    </div>
                    
                    <div style="width:100%; border-top: 1px solid #ccc; padding-top: 20px; margin-top: 10px;">
                        <label style="display:block; font-size:0.9rem; color:#666; margin-bottom:5px;">Choose Icon</label>
                        <div class="avatar-grid" id="avatarGrid">
                            <!-- POPULATES -->
                        </div>
                    </div>
                    <!-- first is free idk if its gonna show up as free if someone already redeemed it.... we'll see -->
                     <button id="saveProfileBtn" class="auth-btn" style="width:100%; justify-content:center;" onclick="window.saveProfile()">Save</button> 
                </div>
                <div id="accLoginOverlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:10; display:none;">
                    <h2>Login Required</h2>
                    <p>login to customize your profile!!</p>
                    <button class="auth-btn google-btn" onclick="window.login()">Login with Google</button>
                </div>
            </div>
        </div>

    </div>

    <div id="taskbar">
        <div class="taskbar-icons">
            <div class="task-icon"><img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/windowssnoitswaddlOS.png?raw=true" alt="Start"></div>
            <div class="task-icon"><img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/seaerch.png?raw=true" alt="Search"></div>
            <div id="task-browser" class="task-icon" onclick="window.toggleWindow('win-browser')"><img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/googlenoitswadgle.png?raw=true" alt="Wadgle"></div>
            <div id="task-clicker" class="task-icon" onclick="window.toggleWindow('win-clicker')"><img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddleclicker.png?raw=true" alt="ClickTheDee"></div>
            <div id="task-account" class="task-icon" onclick="window.toggleWindow('win-account')"><img src="https://cdn-icons-png.flaticon.com/512/1077/1077114.png" alt="My Account" style="filter: invert(0);"></div>
            <div id="task-about" class="task-icon" onclick="window.toggleWindow('win-about')"><img src="https://github.com/waddledeeliveries/waddledeesite/blob/main/waddlOS1024.png?raw=true" alt="About"></div>
        </div>
        <div class="taskbar-right">
            <i class="fa-solid fa-music" style="cursor:pointer;" onclick="window.toggleMusic()" title="Toggle Music"></i>
            <i class="fa-solid fa-wifi"></i>
            <i class="fa-solid fa-volume-high"></i>
            <div id="clock">12:00 PM</div>
        </div>
    </div>
    
    <audio id="wanya" src="https://www.myinstants.com/media/sounds/waddle-dee.mp3"></audio>
    <audio id="bgm" loop src="https://github.com/waddledeeliveries/waddledeesite/raw/refs/heads/main/mainmenuOS.ogg"></audio>
    <audio id="sfx-click" src="https://github.com/waddledeeliveries/waddledeesite/raw/refs/heads/main/clickfast.wav"></audio>
    <audio id="sfx-open" src="https://www.soundjay.com/buttons/sounds/button-3.mp3"></audio>
    <audio id="sfx-jackpot" src="https://github.com/waddledeeliveries/waddledeesite/raw/refs/heads/main/jackpot.mp3"></audio>

</body>
</html>
